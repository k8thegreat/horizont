<?
define("CATALOG_IBLOCK_ID", 1);
define("DEVELOPER_IBLOCK_ID", 2);
define("BANKS_CATALOG_ID", 4);
define("TRADE_IBLOCK_ID", 18);

define("TRANSPORT_ICON",'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 45.437 45.437" xml:space="preserve" width="14px" height="14px" fill="#d4d4d5"><g><path d="M41.403,11.11c-0.371-3.627-0.962-6.451-1.897-7.561c-3.855-4.564-30.859-4.898-33.925,0   c-0.75,1.2-1.276,4.014-1.629,7.567c-1.139,0.134-2.026,1.093-2.026,2.267v4.443c0,0.988,0.626,1.821,1.5,2.146   c-0.207,6.998-0.039,14.299,0.271,17.93c0,2.803,1.883,2.338,1.883,2.338h1.765v3.026c0,1.2,1.237,2.171,2.761,2.171   c1.526,0,2.763-0.971,2.763-2.171V40.24h20.534v3.026c0,1.2,1.236,2.171,2.762,2.171c1.524,0,2.761-0.971,2.761-2.171V40.24h0.58   c0,0,2.216,0.304,2.358-1.016c0-3.621,0.228-11.646,0.04-19.221c0.929-0.291,1.607-1.147,1.607-2.177v-4.443   C43.512,12.181,42.582,11.206,41.403,11.11z M12.176,4.2h20.735v3.137H12.176V4.2z M12.472,36.667c-1.628,0-2.947-1.32-2.947-2.948   c0-1.627,1.319-2.946,2.947-2.946s2.948,1.319,2.948,2.946C15.42,35.347,14.101,36.667,12.472,36.667z M32.8,36.667   c-1.627,0-2.949-1.32-2.949-2.948c0-1.627,1.321-2.946,2.949-2.946s2.947,1.319,2.947,2.946   C35.748,35.347,34.428,36.667,32.8,36.667z M36.547,23.767H8.54V9.077h28.007V23.767z"/></g></svg>');
define("FOOT_ICON", '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 93.646 93.646" fill="#d4d4d5" xml:space="preserve" width="14px" height="14px"><g><path d="M67.971,49.778l-9.378-10.345c-0.584-0.644-1.121-1.971-1.148-2.841L57.1,25.858v-0.311c0-1.654-1.346-3-3-3h-9.18h-3.648   c-1.478,0-3.127,1.047-3.756,2.384l-12.358,26.25c-0.342,0.728-0.376,1.541-0.096,2.292c0.28,0.75,0.84,1.342,1.575,1.666   l1.821,0.803c0.388,0.171,0.802,0.258,1.231,0.258h0c1.177,0,2.273-0.669,2.794-1.704l5.789-11.517v11.576   c-0.024,0.067-0.059,0.128-0.081,0.196l-9.783,30.638c-0.407,1.276-0.283,2.619,0.35,3.781s1.693,1.994,2.987,2.343l0.654,0.177   c0.428,0.116,0.872,0.175,1.318,0.175c2.251,0,4.296-1.481,4.974-3.603l9.141-28.628l3.242,7.941   c0.791,1.937,1.645,5.329,1.865,7.409l1.551,14.621c0.249,2.341,2.1,4.04,4.402,4.04c0.377,0,0.76-0.046,1.137-0.137l0.659-0.16   c2.624-0.635,4.478-3.331,4.133-6.008l-2.297-17.828c-0.292-2.265-1.269-5.812-2.178-7.907l-3.102-7.144   c-0.04-0.093-0.097-0.177-0.143-0.267v-4.841l5.59,5.836c0.556,0.581,1.3,0.901,2.094,0.901c0.803,0,1.553-0.326,2.111-0.918   l1.034-1.098C69.036,52.899,69.055,50.973,67.971,49.778z"/><path d="M48.52,20.005c5.516,0,10.003-4.487,10.003-10.003C58.523,4.487,54.036,0,48.52,0c-5.515,0-10.001,4.487-10.001,10.002   C38.518,15.518,43.005,20.005,48.52,20.005z"/></g></svg>');
define("LIST_VIEW_ICON", '<svg version="1.1" class="svg-result-sort" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" viewBox="0 0 16 16"><path d="M0 1h3v2h-3v-2z"></path><path d="M0 5h3v2h-3v-2z"></path><path d="M0 9h3v2h-3v-2z"></path><path d="M0 13h3v2h-3v-2z"></path><path d="M4 1h12v2h-12v-2z"></path><path d="M4 5h12v2h-12v-2z"></path><path d="M4 9h12v2h-12v-2z"></path><path d="M4 13h12v2h-12v-2z"></path></svg>');
define("BLOCK_VIEW_ICON", '<svg version="1.1" class="svg-result-sort" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="16" height="16" viewBox="0 0 278 278" style="enable-background:new 0 0 278 278;" xml:space="preserve"><g><rect x="0" y="0" width="119.054" height="119.054"/><rect x="158.946" y="0" width="119.054" height="119.054"/><rect x="158.946" y="158.946" width="119.054" height="119.054"/><rect x="0" y="158.946" width="119.054" height="119.054"/></g></svg>');
define("MAP_VIEW_ICON", '<svg version="1.1" class="svg-result-sort" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="16" height="16" viewBox="0 0 54.757 54.757" style="enable-background:new 0 0 54.757 54.757;" xml:space="preserve"><path d="M40.94,5.617C37.318,1.995,32.502,0,27.38,0c-5.123,0-9.938,1.995-13.56,5.617c-6.703,6.702-7.536,19.312-1.804,26.952 L27.38,54.757L42.721,32.6C48.476,24.929,47.643,12.319,40.94,5.617z M27.557,26c-3.859,0-7-3.141-7-7s3.141-7,7-7s7,3.141,7,7 S31.416,26,27.557,26z"/></svg>');
define("FILTER_ICON",'<svg class="svg-result-sort" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612.006 612.006" xml:space="preserve"><path d="M292.911,318.872H14.833C6.639,318.872,0,312.232,0,304.04c0-8.194,6.639-14.833,14.833-14.833h278.078 c8.194,0,14.833,6.639,14.833,14.833C307.744,312.232,301.105,318.872,292.911,318.872z"/><path d="M597.167,318.872H449.638c-8.193,0-14.833-6.64-14.833-14.833c0-8.194,6.64-14.833,14.833-14.833h147.529 c8.193,0,14.833,6.639,14.833,14.833C612,312.232,605.36,318.872,597.167,318.872z"/><path d="M214.545,506.712H14.833C6.639,506.712,0,500.072,0,491.88c0-8.193,6.639-14.834,14.833-14.834h199.712 c8.194,0,14.833,6.641,14.833,14.834C229.378,500.072,222.739,506.712,214.545,506.712z"/><path d="M597.167,506.712H371.266c-8.193,0-14.833-6.64-14.833-14.833c0-8.192,6.64-14.833,14.833-14.833h225.901 c8.193,0,14.833,6.641,14.833,14.833C612,500.072,605.36,506.712,597.167,506.712z"/><path d="M129.368,134.96H14.833C6.639,134.96,0,128.32,0,120.127s6.639-14.833,14.833-14.833h114.535 c8.193,0,14.833,6.639,14.833,14.833S137.562,134.96,129.368,134.96z"/><path d="M597.167,134.96H286.1c-8.194,0-14.833-6.639-14.833-14.833s6.639-14.833,14.833-14.833h311.073 c8.193,0,14.833,6.639,14.833,14.833C612,128.32,605.36,134.96,597.167,134.96z"/><path d="M175.635,181.215c-33.695,0-61.101-27.406-61.101-61.1c0-33.683,27.406-61.089,61.101-61.089 c33.683,0,61.088,27.406,61.088,61.089C236.718,153.81,209.312,181.215,175.635,181.215z M175.635,88.693 c-17.331,0-31.434,14.097-31.434,31.422c0,17.331,14.103,31.434,31.434,31.434c17.325,0,31.422-14.104,31.422-31.434 C207.052,102.791,192.954,88.693,175.635,88.693z"/><path d="M257.709,552.979c-33.695,0-61.1-27.406-61.1-61.102c0-33.688,27.405-61.095,61.1-61.095 c33.689,0,61.094,27.406,61.094,61.095C318.798,525.573,291.393,552.979,257.709,552.979z M257.709,460.45 c-17.331,0-31.434,14.099-31.434,31.43c0,17.33,14.103,31.435,31.434,31.435s31.428-14.104,31.428-31.435 C289.137,474.549,275.035,460.45,257.709,460.45z"/><path d="M339.173,365.121c-33.689,0-61.095-27.404-61.095-61.094c0-33.683,27.406-61.089,61.095-61.089 c33.688,0,61.094,27.406,61.094,61.089C400.267,337.716,372.861,365.121,339.173,365.121z M339.173,272.605 c-17.331,0-31.429,14.097-31.429,31.422c0,17.331,14.098,31.428,31.429,31.428s31.428-14.097,31.428-31.428 C370.601,286.702,356.504,272.605,339.173,272.605z"/></svg>');
define("TIME_ICON", '<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="14px" height="14px" viewBox="0 0 97.16 97.16" fill="#d4d4d5" xml:space="preserve"><g><path d="M48.58,0C21.793,0,0,21.793,0,48.58s21.793,48.58,48.58,48.58s48.58-21.793,48.58-48.58S75.367,0,48.58,0z M48.58,86.823 c-21.087,0-38.244-17.155-38.244-38.243S27.493,10.337,48.58,10.337S86.824,27.492,86.824,48.58S69.667,86.823,48.58,86.823z"/><path d="M73.898,47.08H52.066V20.83c0-2.209-1.791-4-4-4c-2.209,0-4,1.791-4,4v30.25c0,2.209,1.791,4,4,4h25.832 c2.209,0,4-1.791,4-4S76.107,47.08,73.898,47.08z"/></g></svg>');

global $linesArr;

$linesArr = array(
    "green" => array(50, 8, 16, 34, 4, 21, 33, 51, 43, 54),
    "red" => array(17, 18, 3, 49, 38, 31, 14, 29, 64, 13, 10, 53, 60, 5, 39, 24, 1, 30, 9),
    "blue" => array(46, 52, 44, 61, 48, 63, 47, 15, 40, 56, 60, 62, 37, 66, 45, 36, 22, 27),
    "orange" => array(57, 19, 32, 4, 41, 28, 6, 20),
    "purple" => array(25, 59, 26, 65, 58, 55, 23, 42, 11, 7, 35)
);

function getMetroIcon($class){
    return '<svg version="1.1" class="'.$class.'" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="14px" height="14px" viewBox="0 0 94.69 94.691" xml:space="preserve"><g><path d="M62.695,10.642l-15.35,48.393L31.996,10.642C13.737,16.918,0,33.943,0,53.461c0,11.756,4.796,22.597,12.555,30.587h22.254 l2.333-10.117C10.556,63.514,15.583,31.235,25.221,25.966C26.365,26.31,43.129,83.81,43.129,83.81c0.229,0,0.973,0,1.882,0 c0.192,0,0.915,0,1.816,0c0.326,0,0.678,0,1.035,0c0.612,0,1.247,0,1.815,0c0.91,0,1.653,0,1.883,0c0,0,16.765-57.5,17.908-57.844 c9.639,5.269,14.664,37.548-11.922,47.965l2.334,10.117h22.254c7.76-7.99,12.556-18.831,12.556-30.587 C94.69,33.943,80.953,16.918,62.695,10.642z"/></g></svg>';
}

function getColoredIcon($id){
    global $linesArr;
    $result="";
    foreach ($linesArr as $color => $arr){
        if(in_array($id, $arr))
            $result.= getMetroIcon("ico-".$color);
    }
    return $result;
}

function cmp($a, $b)
{
    $aArr = explode(" ", $a);
    $bArr = explode(" ", $b);
    if (($aArr[0] == $bArr[0]) && ($aArr[2] == $bArr[2])) {
        return 0;
    }
    return (($aArr[2] < $bArr[2]) || (($aArr[2] == $bArr[2]) && $aArr[0] < $bArr[0]))  ? -1 : 1;
}

function convertQuaterToDate($quater, $year){
    $quater = IntVal($quater);
    switch ($quater){
        case 1:
            $month = "01.02";
            break;
        case 2:
            $month = "01.05";
            break;
        case 3:
            $month = "01.08";
            break;
        case 4:
            $month = "01.11";
            break;
    }
    $date = $month.".".$year." 00:00:00";
    return $date;
}

AddEventHandler("iblock", "OnBeforeIBlockElementAdd", "addCodeFunction");
AddEventHandler("iblock", "OnBeforeIBlockSectionAdd", "addCodeFunction");
AddEventHandler("iblock", "OnAfterIBlockElementAdd", "updatePrice");
AddEventHandler("iblock", "OnAfterIBlockElementUpdate", "updatePrice");

function addCodeFunction(&$arFields)
{
    if(in_array($arFields["IBLOCK_ID"], array(CATALOG_IBLOCK_ID, DEVELOPER_IBLOCK_ID, BANKS_CATALOG_ID))) {
        $arParams = array(
            "max_len" => "60", // обрезаем символьный код до 60 символов
            "change_case" => "L", // приводим к нижнему регистру
            "replace_space" => "-", // меняем пробелы на тире
            "replace_other" => "-", // меняем плохие символы на тире
            "delete_repeat_replace" => "true", // удаляем повторяющиеся тире
            "use_google" => "false", // отключаем использование google
        );
        $arFields["CODE"] = Cutil::translit($arFields["NAME"], "ru", $arParams);
        $arFields["CODE"] = $arFields["CODE"];

    }
}

function updatePrice(&$arFields){
    if($arFields["IBLOCK_ID"] == CATALOG_IBLOCK_ID && $arFields["RESULT"]){

        if($arFields["PROPERTY_VALUES"][27][$arFields["ID"].":27"]["VALUE"]) {
            $price = $arFields["PROPERTY_VALUES"][27][$arFields["ID"] . ":27"]["VALUE"];
            $sectionID = $arFields["IBLOCK_SECTION"][0];
            if($sectionID){
                $uf_arresult = CIBlockSection::GetList(Array(), Array("IBLOCK_ID" => CATALOG_IBLOCK_ID, "ID" => $sectionID), false, array("UF_MIN_PRICE"));
                if ($uf_value = $uf_arresult->GetNext()) {
                    if ($price > $uf_value["UF_MIN_PRICE"]) {
                        $bs = new CIBlockSection;
                        $bs->Update($sectionID, array("UF_MIN_PRICE" => $price));
                    }
                }
            }
        }
        if($arFields["PROPERTY_VALUES"]["price_discount"]) {
            $price = $arFields["PROPERTY_VALUES"]["price_discount"];
            $sectionID = $arFields["IBLOCK_SECTION"][0];
            if ($sectionID) {
                $uf_arresult = CIBlockSection::GetList(Array(), Array("IBLOCK_ID" => CATALOG_IBLOCK_ID, "ID" => $sectionID), false, array("UF_MIN_PRICE"));
                if ($uf_value = $uf_arresult->GetNext()) {
                    if ($price > $uf_value["UF_MIN_PRICE"]) {
                        $bs = new CIBlockSection;
                        $bs->Update($sectionID, array("UF_MIN_PRICE" => $price));
                    }
                }
            }
        }
    }
}

function setMinPrice($sectionID){
    if (CModule::IncludeModule("iblock")) {
        $arSelect = Array("ID", "NAME", "PROPERTY_price_discount");
        $arFilter = Array("IBLOCK_ID" => CATALOG_IBLOCK_ID, "ACTIVE" => "Y", "IBLOCK_SECTION_ID" => $sectionID);
        $res = CIBlockElement::GetList(Array("PROPERTY_price_discount" => "ASC"), $arFilter, array("PROPERTY_price_discount"), Array(), $arSelect);
        if ($ob = $res->GetNextElement()) {
            $arFields = $ob->GetFields();
            $price = $arFields["PROPERTY_PRICE_DISCOUNT_VALUE"];
            if($price>0){
                $bs = new CIBlockSection;
                $bs->Update($sectionID, array("UF_MIN_PRICE" => $price));
            }
        }

    }
}

function setMinPriceAll(){
    if (CModule::IncludeModule("iblock")) {
        $res = CIBlockSection::GetList(Array(), Array("IBLOCK_ID" => CATALOG_IBLOCK_ID, "ACTIVE" => "Y"), false, array());
        while($arSection = $res->GetNext()) {
            $sectionID = $arSection["ID"];
            setMinPrice($sectionID);
        }
    }
}


class IconedText extends CUserTypeString
{
    function GetUserTypeDescription()
    {
        return array(
            "USER_TYPE_ID" => "iconed_text",
            "CLASS_NAME" => "IconedText",
            "DESCRIPTION" => "Текст с иконкой",
            "BASE_TYPE" => "string",
        );
    }
//Этот метод вызывается для показа значений в списке
    function GetAdminListViewHTML($arUserField, $arHtmlControl)
    {
        if(strlen($arHtmlControl["VALUE"])>0)
            return "{".$arHtmlControl["VALUE"]."}";
        else
            return ' ';
    }
}
AddEventHandler("main", "OnUserTypeBuildList", array("IconedText", "GetUserTypeDescription"));
require_once "include/xml_reader.php";
?>